<?xml version="1.0" encoding="UTF-8"?>
<root>
	<windowclass name="item" merge="join">
		<sizelimits>
			<minimum width="350" />
		</sizelimits>
		<sheetdata>
			<frame_record_content name="contentframe" merge="delete" />
			<frame_record_content_tabbed name="contentframe" insertbefore="main" />

			<subwindow_record name="actions">
				<class>item_actions</class>
			</subwindow_record>

			<subwindow_record name="empty_actions">
				<class>empty_item_actions</class>
			</subwindow_record>

			<scrollbar_record>
				<target>actions</target>
			</scrollbar_record>

			<tabs_recordsheet name="tabs">
				<script>
					function onInit()
						if super and super.onInit then
							super.onInit();
						end
						local nodeRecord = window.getDatabaseNode();
						local isIdentifiedPath = nodeRecord.getPath("isidentified");
						DB.addHandler(isIdentifiedPath, "onUpdate", onIdentifiedChanged);
						update(DB.getValue(isIdentifiedPath) ~= 0);
					end
					function onClose()
						local nodeRecord = window.getDatabaseNode();
						DB.removeHandler(nodeRecord.getPath("isidentified"), "onUpdate", onIdentifiedChanged);
						if super and super.onClose then
							super.onClose();
						end
					end
					function onIdentifiedChanged(nodeIdentified)
						local bIdentified = nodeIdentified.getValue() ~= 0;
						update(bIdentified);
					end
					function update(bIdentified)
						if bIdentified or Session.IsHost then
							setTab(2, "actions", "tab_actions");
						else
							setTab(2, "empty_actions", "tab_actions");
						end
					end
				</script>
				<tab>
					<icon>tab_main</icon>
					<subwindow>main</subwindow>
				</tab>
				<tab>
					<icon>tab_actions</icon>
					<subwindow>actions</subwindow>
				</tab>
			</tabs_recordsheet>
		</sheetdata>
	</windowclass>

	<windowclass name="item_header" merge="join">
		<sheetdata>
			<stringcontrol name="count" insertbefore="name">
				<script>
					function onInit()
						local node = window.getDatabaseNode().getChild("count");
						if node then
							setVisible(true);
							update(node);
							DB.addHandler(node.getPath(), "onUpdate", update);
						end
					end
					function onClose()
						local node = window.getDatabaseNode().getChild("count");
						if node then
							DB.removeHandler(node.getPath(), "onUpdate", update);
						end
					end
					function update(node)
						setValue(string.format("(x%i)", node.getValue()));
					end
				</script>
				<anchored width="40" height="20">
					<top offset="5" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-5" />
				</anchored>
				<font>sheetlabel</font>
				<nodrag />
				<readonly />
				<invisible />
			</stringcontrol>
		</sheetdata>
	</windowclass>

	<windowclass name="empty_item_actions" />

	<windowclass name="item_actions">
		<script file="campaign/scripts/item_actions.lua" />
		<sheetdata>
			<label_itemframetop name="chargestitle">
				<anchored height="20">
					<top offset="10" />
					<left offset="15" />
					<right offset="-10" />
				</anchored>
				<static textres="item_label_charges" />
				<icons>char_powers</icons>
				<target>charges</target>
			</label_itemframetop>

			<subwindow name="charges">
				<class>item_charges</class>
				<anchored>
					<top parent="chargestitle" anchor="bottom" offset="5" />
					<left offset="5" />
					<right offset="-5" />
				</anchored>
				<activate />
				<fastinit />
			</subwindow>

			<label_itemframetop name="powerstitle">
				<anchored height="20">
					<top parent="charges" anchor="bottom" offset="10" />
					<left offset="15" />
					<right offset="-10" />
				</anchored>
				<static textres="char_label_powers" />
				<icons>char_powers</icons>
				<target>powerlist</target>
			</label_itemframetop>

			<button_iedit name="powerlist_iedit">
				<anchored to="powerstitle" position="insidetopright" offset="0,0" />
				<target>powerlist</target>
			</button_iedit>
			<button_iadd name="powerlist_iadd">
				<anchored to="powerlist_iedit" position="lefthigh" offset="5,0" />
				<target>powerlist</target>
			</button_iadd>

			<windowlist name="powerlist">
				<script>
					function update()
						local bEditMode = (window.powerlist_iedit.getValue() == 1);
						for _,win in pairs(getWindows()) do
							win.idelete.setVisibility(bEditMode);
						end
					end
					function addEntry(bFocus)
						local win = createWindow();
						if bFocus and win then
							win.name.setFocus();
						end
						return win;
					end
				</script>
				<anchored>
					<top parent="powerstitle" anchor="bottom" offset="5" />
					<left offset="5" />
					<right offset="-5" />
				</anchored>
				<datasource>.powers</datasource>
				<class>item_power</class>
				<skipempty />
				<noscroll />
				<allowcreate />
				<allowdelete />
				<footer>footer_wide</footer>
			</windowlist>

			<label_itemframetop name="miscstitle">
				<anchored height="20">
					<top parent="powerlist" anchor="bottom" offset="10" />
					<left offset="15" />
					<right offset="-10" />
				</anchored>
				<static textres="item_label_miscellaneous" />
				<icons>char_notes</icons>
				<target>miscellaneous</target>
			</label_itemframetop>
			<subwindow name="miscellaneous">
				<class>item_general</class>
				<anchored>
					<top parent="miscstitle" anchor="bottom" offset="5" />
					<left offset="5" />
					<right offset="-5" />
				</anchored>
				<activate />
				<fastinit />
			</subwindow>
		</sheetdata>
	</windowclass>

	<windowclass name="item_charges">
		<script file="campaign/scripts/item_charges.lua" />
		<margins control="0,0,0,5" />
		<sheetdata>
			<label name="chargesLabel">
				<anchored position="insidetopleft" width="60" offset="5,2" />
				<static textres="item_use_charges" />
			</label>
			<basicnumber name="prepared">
				<anchored to="chargesLabel" position="right" offset="5" width="30" />
			</basicnumber>
			<button_stringcycler name="rechargeperiod">
				<script>
					local initializeOriginal;
					function onInit()
						if super then
							initializeOriginal = super.initialize;
							super.initialize = initialize;
							if super.onInit then
								super.onInit();
							end
						end
					end
					function initialize(sLabels, sValues, sDefaultLabel, sInitialValue)
						if ExtendedRest then
							sLabels = sLabels .. "|" .. Interface.getString("extended_rest_label");
							sValues = sValues .. "|extended";
						end
						if LongTermEffects then
							sLabels = sLabels .. "|" .. Interface.getString("item_recharge_daily");
							sValues = sValues .. "|daily";
						end
						initializeOriginal(sLabels, sValues, sDefaultLabel, sInitialValue);
					end
				</script>
				<anchored to="prepared" width="60" height="20">
					<top />
					<left anchor="right" offset="10" />
				</anchored>
				<parameters>
					<defaultlabelres>item_recharge_never</defaultlabelres>
					<labelsres>item_recharge_long|item_recharge_short</labelsres>
					<values>long|short</values>
				</parameters>
			</button_stringcycler>
			<button_stringcycler name="rechargetime">
				<anchored to="rechargeperiod" width="60" height="20">
					<top />
					<left anchor="right" offset="10" />
				</anchored>
				<parameters>
					<defaultlabelres>item_recharge_dawn</defaultlabelres>
					<labelsres>item_recharge_noon|item_recharge_dusk|item_recharge_midnight</labelsres>
					<values>noon|dusk|midnight</values>
				</parameters>
			</button_stringcycler>
			
			<label name="rechargeLabel">
				<anchored to="chargesLabel" width="60" offset="5,2">
					<top anchor="bottom" offset="10" />
					<left anchor="left" />
				</anchored>
				<static textres="label_item_recharge" />
			</label>
			<basicdice name="rechargedice">
				<anchored to="rechargeLabel" position="righthigh" offset="5,0" width="60" height="20" />
			</basicdice>
			<label name="label_plus">
				<anchored to="rechargedice" position="righthigh" offset="3,0" width="10" />
				<static>+</static>
			</label>
			<basicnumber name="rechargebonus">
				<anchored to="label_plus" position="righthigh" offset="2,0" width="35" height="20" />
				<hideonvalue>0</hideonvalue>
			</basicnumber>
		</sheetdata>
	</windowclass>

	<windowclass name="item_general">
		<margins control="0,0,0,5" />
		<script>
			function update(bLocked)
				displaygroup.setReadOnly(bLocked);

				if bLocked then
					displaygroup.setFrame(nil);
				else
					displaygroup.setFrame("fielddark", 7, 5, 7, 5);
				end
			end
		</script>
		<sheetdata>
			<label name="label_displaygroup">
				<anchored position="insidetopleft" width="90" offset="5,2" />
				<static textres="item_label_display_group" />
			</label>
			<simplestring name="displaygroup">
				<anchored to="label_displaygroup" height="20">
					<left anchor="right" offset="5" />
					<top />
					<right parent="" offset="-5" />
				</anchored>
				<multilinespacing>20</multilinespacing>
				<nodrag />
				<delaykeyupdate />
			</simplestring>
		</sheetdata>
	</windowclass>
</root>