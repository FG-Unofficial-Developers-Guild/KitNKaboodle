<?xml version="1.0" encoding="UTF-8"?>
<root>
	<template name="button_itemaction">
		<button_roll>
			<script>
				function action(draginfo)
					local nodeAction = window.getDatabaseNode();
					ActorManagerKNK.beginResolvingItem(nodeAction.getChild(".......") or true);
					PowerManager.performPCPowerAction(draginfo, nodeAction, subroll and subroll[1])
					ActorManagerKNK.endResolvingItem();
				end

				function onButtonPress(x, y)
					action();
				end
				
				function onDragStart(button, x, y, draginfo)
					action(draginfo);
					return true;
				end
			</script>
		</button_roll>
	</template>

	<template name="item_charge_tracker">
		<genericcontrol>
			<anchored position="insidetopleft" width="0" height="0" />
			<script>
				function onInit()
					local node = window.getDatabaseNode();
					onChargesChanged();
					DB.addHandler(node.getPath("count"), "onUpdate", onChargesChanged);
					DB.addHandler(node.getPath("prepared"), "onUpdate", onChargesChanged);
					DB.addHandler(node.getPath("powers.*.cast"), "onUpdate", onChargesChanged);
				end
				function onClose()
					local node = window.getDatabaseNode();
					DB.removeHandler(node.getPath("count"), "onUpdate", onChargesChanged);
					DB.removeHandler(node.getPath("prepared"), "onUpdate", onChargesChanged);
					DB.removeHandler(node.getPath("powers.*.cast"), "onUpdate", onChargesChanged);
				end
				function onChargesChanged()
					local node = window.getDatabaseNode();
					local nTotal = DB.getValue(node, "prepared", 0) * DB.getValue(node, "count", 1);
					local nUsed = countCharges();
					for _, win in ipairs(window.powerlist.getWindows()) do
						win.updateUses(nTotal, nUsed);
					end
				end
				function countCharges()
					local node = window.getDatabaseNode();
					if not node then
						Debug.chat(window);
						Debug.printstack();
					end
					Debug.chat(node);
					local nCount = 0;
					for _,powerNode in pairs(DB.getChildren(node.getPath("powers"))) do
						nCount = nCount + DB.getValue(powerNode, "cast", 0);
					end
					return nCount;
				end
			</script>
		</genericcontrol>
	</template>

	<template name="label_itemframetop">	
		<label_charframetop>
			<script>
				local targetControl;
				function onInit()
					if super and super.onInit then
						super.onInit();
					end
					if target then
						targetControl = window[target[1]];
					end
				end
				function onClickDown()
					return true;
				end
				function onClickRelease()
					if not targetControl then
						return true;
					end
					local bVisible = targetControl.isVisible();
					if bVisible then
						setFont("subwindowsmalltitle_disabled");
						targetControl.setVisible(false);
					else
						setFont("subwindowsmalltitle");
						targetControl.setVisible(true);
					end
					return true;
				end
			</script>
		</label_charframetop>
	</template>

	<template name="string_item_poweractionview">
		<stringcontrol>
			<frame name="fieldlight" offset="7,5,7,5" />
			<multilinespacing>20</multilinespacing>
			<font>sheettext</font>
			<center />
			<nodrag />
			<readonly />
			<cursor hover="hand" />
			<script>
				function action(draginfo)
					local nodeAction = window.getDatabaseNode();
					ActorManagerKNK.beginResolvingItem(nodeAction.getChild(".......") or true);
					PowerManager.performPCPowerAction(draginfo, nodeAction, subroll and subroll[1])
					ActorManagerKNK.endResolvingItem();
				end

				function onDoubleClick(x, y)
					action();
					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					action(draginfo);
					return true;
				end
			</script>
		</stringcontrol>
	</template>
</root>